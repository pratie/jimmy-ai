(function(){
  if (typeof window === 'undefined' || typeof document === 'undefined') return;

  var FLAG='__bml_embed_loaded__';
  if (window[FLAG]) return; window[FLAG]=true;

  // Resolve current script element
  var cur=document.currentScript;
  if(!cur){var scripts=document.getElementsByTagName('script');for(var i=scripts.length-1;i>=0;i--){if((scripts[i].src||'').indexOf('/embed.min.js')!==-1){cur=scripts[i];break;}}}

  // Read config
  var domainId=(cur&&(cur.getAttribute('data-domain-id')||cur.id))||'';
  var appOrigin=(cur&&(cur.getAttribute('data-app-origin')))||'';
  var margin=24; // px
  var bubbleSize='sm'; // default to small (matches close button)
  try{
    if(cur){
      var mAttr=cur.getAttribute('data-margin');
      if(mAttr){var m=parseInt(mAttr,10); if(!isNaN(m)&&m>0&&m<=96) margin=m;}
      var sAttr=cur.getAttribute('data-size');
      if(sAttr==='sm'||sAttr==='md') bubbleSize=sAttr;
    }
  }catch(_){ }

  if(!appOrigin){appOrigin=(location.hostname==='localhost'||location.hostname==='127.0.0.1')?'http://localhost:3000':'https://chatdock.io'}
  if(!domainId){console.error('[ChatDock] Missing domain id on embed script (use id or data-domain-id)');return}

  try{ if(window.top!==window.self) return }catch(e){ return }

  var prev=window.bml; window.bml=function(cmd){ if(cmd==='getState') return 'initialized'; if(cmd==='open'){try{iframe&&iframe.focus()}catch(_){} return} if(cmd==='destroy'){try{iframe&&iframe.remove()}catch(_){} return} }; window.bml.q=(prev&&prev.q)?prev.q:[]; try{for(var i2=0;i2<window.bml.q.length;i2++){try{window.bml.apply(null,window.bml.q[i2])}catch(_){}}}catch(_){}

  // Styles with dynamic margin - TRANSPARENT background, no shadow on iframe
  var STYLE_ID='bml-chat-styles'; if(!document.getElementById(STYLE_ID)){ var st=document.createElement('style'); st.id=STYLE_ID; var mSm=Math.max(12,Math.floor(margin*0.66)); st.textContent='.bml-chat-frame{position:fixed;bottom:'+margin+'px;right:'+margin+'px;border:none;z-index:2147483647;background:transparent}'+ '@media(max-width:640px){.bml-chat-frame{bottom:'+mSm+'px;right:'+mSm+'px}}'; document.head.appendChild(st); }

  // Create iframe (floating widget) - explicitly transparent
  var iframe=document.createElement('iframe'); iframe.className='bml-chat-frame'; iframe.src=appOrigin+'/chatbot'; iframe.title='ChatDock Chatbot'; iframe.width=(bubbleSize==='sm'?'64':'80'); iframe.height=(bubbleSize==='sm'?'64':'80'); iframe.style.background='transparent'; iframe.style.colorScheme='normal'; iframe.allowTransparency='true';

  var sent=false;
  function handleMessage(e){ if(e.origin!==appOrigin) return; var data=e.data; try{ if(typeof data==='string') data=JSON.parse(data) }catch(_){ return } if(!data||typeof data.width!=='number'||typeof data.height!=='number') return; var w=data.width,h=data.height; if(w>120){ try{ var vw=Math.max(document.documentElement.clientWidth||0,window.innerWidth||0); var vh=Math.max(document.documentElement.clientHeight||0,window.innerHeight||0); var maxW=Math.min(480,vw-margin*2); var maxH=Math.min(720,vh-margin*2); var minW=360,minH=520; if(vw<640){ var fillW=Math.max(300,vw-margin*2); var fillH=Math.max(420,vh-margin*2); minW=fillW; maxW=fillW; minH=fillH; maxH=fillH; } w=Math.max(minW,Math.min(maxW,w)); h=Math.max(minH,Math.min(maxH,h)); }catch(_){} } iframe.width=String(w); iframe.height=String(h); if(!sent){ sent=true; try{ iframe.contentWindow&&iframe.contentWindow.postMessage(domainId,appOrigin) }catch(_){} }}
  window.addEventListener('message',handleMessage);

  function mount(){ if(!document.body){ document.addEventListener('DOMContentLoaded',mount,{once:true}); return } document.body.appendChild(iframe) }
  mount();

  iframe.onload=function(){ setTimeout(function(){ if(!sent){ sent=true; try{ iframe.contentWindow&&iframe.contentWindow.postMessage(domainId,appOrigin) }catch(_){} } },1500) };
})();
