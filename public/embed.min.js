(function(){
  if (typeof window === 'undefined' || typeof document === 'undefined') return;

  // Prevent double-injection
  var FLAG = '__bml_embed_loaded__';
  if (window[FLAG]) return; window[FLAG] = true;

  // Resolve current script element
  var cur = document.currentScript;
  if (!cur) {
    var scripts = document.getElementsByTagName('script');
    for (var i = scripts.length - 1; i >= 0; i--) {
      if ((scripts[i].src||'').indexOf('/embed.min.js') !== -1) { cur = scripts[i]; break; }
    }
  }

  // Read config from script attributes
  var domainId = (cur && (cur.getAttribute('data-domain-id') || cur.id)) || '';
  var appOrigin = (cur && (cur.getAttribute('data-app-origin'))) || '';
  if (!appOrigin) {
    // Fallback to production domain unless on localhost
    appOrigin = (location.hostname === 'localhost' || location.hostname === '127.0.0.1')
      ? 'http://localhost:3000'
      : 'https://www.bookmylead.app';
  }

  if (!domainId) {
    console.error('[BookmyLead] Missing domain id on embed script (use id or data-domain-id)');
    return;
  }

  // Do not run inside iframes
  try { if (window.top !== window.self) return; } catch (e) { return; }

  // Expose minimal API and drain queued calls
  var prev = window.bml;
  window.bml = function(cmd){
    if (cmd === 'getState') return 'initialized';
    if (cmd === 'open') { try { iframe && iframe.focus(); } catch (_) {} return; }
    if (cmd === 'destroy') { try { iframe && iframe.remove(); } catch (_) {} return; }
  };
  window.bml.q = (prev && prev.q) ? prev.q : [];
  // Drain any queued calls (best-effort)
  try { for (var i=0;i<window.bml.q.length;i++){ try{ window.bml.apply(null, window.bml.q[i]); }catch(_){} } } catch(_){}

  // Inject base styles
  var STYLE_ID = 'bml-chat-styles';
  if (!document.getElementById(STYLE_ID)){
    var st = document.createElement('style');
    st.id = STYLE_ID;
    st.textContent = '.bml-chat-frame{position:fixed;bottom:24px;right:24px;border:none;z-index:2147483647;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.2);background:#fff}'+
                     '@media(max-width:640px){.bml-chat-frame{bottom:16px;right:16px}}';
    document.head.appendChild(st);
  }

  // Create iframe (floating widget)
  var iframe = document.createElement('iframe');
  iframe.className = 'bml-chat-frame';
  iframe.src = appOrigin + '/chatbot';
  iframe.title = 'BookmyLead Chatbot';
  iframe.width = '80';
  iframe.height = '80';

  var sent = false;
  function handleMessage(e){
    if (e.origin !== appOrigin) return;
    var data = e.data;
    try { if (typeof data === 'string') data = JSON.parse(data); } catch(_) { return; }
    if (!data || typeof data.width !== 'number' || typeof data.height !== 'number') return;

    var w = data.width, h = data.height;
    // Clamp open size to viewport with margins; keep compact closed size untouched
    if (w > 120) {
      try {
        var vw = Math.max(document.documentElement.clientWidth || 0, window.innerWidth || 0);
        var vh = Math.max(document.documentElement.clientHeight || 0, window.innerHeight || 0);
        var margin = 24;
        var maxW = Math.min(420, vw - margin*2);
        var maxH = Math.min(680, vh - margin*2);
        var minW = 320, minH = 420;
        w = Math.max(minW, Math.min(maxW, w));
        h = Math.max(minH, Math.min(maxH, h));
      } catch(_){}
    }

    iframe.width = String(w);
    iframe.height = String(h);
    if (!sent) {
      sent = true;
      try { iframe.contentWindow && iframe.contentWindow.postMessage(domainId, appOrigin); } catch(_) {}
    }
  }
  window.addEventListener('message', handleMessage);

  function mount(){
    if (!document.body) { document.addEventListener('DOMContentLoaded', mount, { once: true }); return; }
    document.body.appendChild(iframe);
  }
  mount();

  // Fallback: ensure ID is sent if no resize message comes soon
  iframe.onload = function(){
    setTimeout(function(){
      if (!sent) {
        sent = true;
        try { iframe.contentWindow && iframe.contentWindow.postMessage(domainId, appOrigin); } catch(_) {}
      }
    }, 1500);
  };
})();
